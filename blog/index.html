
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="">
    <link rel="shortcut icon" href="../assets/ico/favicon.ico">

    <title>eatabit.com | Blog</title>

    <link rel="stylesheet" href="../assets/stylesheets/bootstrap.min.css">
    <link rel="stylesheet" href="../assets/stylesheets/font-awesome.min.css">
    <link rel="stylesheet" href="../assets/stylesheets/application.css">
    <link rel="stylesheet" href="../assets/stylesheets/blog.css">

    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
      <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-1620191-7', 'eatabit.com');
      ga('send', 'pageview');

    </script>
  </head>

  <body class="blog">

    <nav class="navbar navbar-default navbar-fixed-top" role="navigation">
      <div class="container">
        <div class="navbar-header">
          <img class="pull-left" src="../assets/images/logo.png"/>
          <a class="navbar-brand" href="../index.html">textual mealing</a>
        </div>
        <div class="pull-right">
          <p class="navbar-text">
            <a href="../locations.html" class="btn btn-danger btn-xs">
              <i class="fa fa-star"></i> Our Locations
            </a>
          </p>
          <p class="navbar-text hidden-xs">
            <button type="button" class="btn btn-success btn-xs" data-toggle="modal" data-target="#myModal" data-toggle="tooltip" data-placement="bottom" title="How it works">
              <i class="fa fa-video-camera"></i>
            </button>
          </p>
          <p class="navbar-text hidden-xs">
            <a href="https://twitter.com/eatabit" class="navbar-link btn btn-info btn-xs" data-toggle="tooltip" data-placement="bottom" title="Twitter"><i class="fa fa-twitter"></i> </a>
          </p>
          <p class="navbar-text hidden-xs">
            <a href="mailto:greg@eatabit.com" class="navbar-link btn btn-info btn-xs" data-toggle="tooltip" data-placement="bottom" title="Email"><i class="fa fa-envelope"></i> </a>
          </p>
        </div>
      </div>
    </nav>

    <div class="container">

      <div class="blog-header">
        <h1 class="blog-title"><i class="fa fa-signal"></i> The eatabit.com blog</h1>
        <p class="lead">Peaks and troughs in the <a href="http://charlestonmag.com/features/the_rise_of_silicon_harbor">Silicon Harbor.</a></p>
      </div>

      <div class="row">

        <div class="col-sm-8 blog-main">

          <div class="blog-post">
            <h2 class="blog-post-title">Post Mortem: A single whitespace character</h2>
            <p class="blog-post-meta">October 26th, 2014 by <a href="#">Greg</a></p>

            <hr>
            <p>
              <a href="http://dashboard.eatabit.io/eatabit_tv">
                <img src="../assets/images/blog/dashboard.png" alt="eatabit.com Dashboard">
              </a>
            </p>
            <hr/>
            <p class="indent">
              We have been running eatabit.com here in Charleston, SC for about a year now. 
              Over that time, our cellular printing api has printed over 9300 food orders for our client restaurants, stadiums and golf courses. 
              Working with cellular has its difficulties - especially in areas with high traffic volume like stadiums during events but we have systems which watch out for conditions like poor signal quality and outages. 
            </p>
            <hr/>
            <p>
              Paisano's Pizza: James Island
              <img src="../assets/images/blog/cellular_chart.png" alt="cellular chart">
            </p>
            <hr/>
            <p class="indent">
              Wednesday nights are usually our second-slowest night (Tuesday being the slowest) so when the monitors started spewing out an avalanche of alerts right around midnight, we thought it was a fluke. 
              Unfortunately it wasn't....
            </p>
            <hr/>
            <p>
              <img src="../assets/images/blog/chat_bubble.png" alt="cellular chart">
            </p>
            <hr/>
            <p class="indent">
              Well, outages happen. 
              Sometimes a restaurant has new staff and they unplug the printer to "turn it off" at night but this was ALL the printers. 
              Our SIM provider, T-Mobile, can sometimes reboot a tower and we see a cluster of printers with an outage that lasts 60-90 seconds but this was ALL the printers in Charleston. 
            </p>
            <p class="indent">
              Ok, let's start the troubleshooting process by looking at the logging on the cellular printers themselves...
            </p>
            <p>
              <img src="../assets/images/blog/printer.png" alt="eatabit printer">
            </p>
            <hr/>
            <p class="indent">
              The printers are based on an Arduino Mega (ATMega 1280) chipset so we fired up the Arduino IDE and watched the serial monitor:
            </p>
            <hr/>
            <pre>SYSTEM::State: Polling.<br/>SYSTEM::Polling: SYSTEM::State: Idle.
              <br/>WEB::Starting Poll!<br/>WEB::Poll Request:
              <br/>GET /v1/printer/***************/orders.txt  HTTP/1.1<br/>HOST: api.eatabit.io<br/>Authorization: Basic ***********************************************<br/>User-Agent: Eatabit_Device/0.5.1<br/>Content-Length: 67<br/>Content-Type: application/x-www-form-urlencoded<br/>Accept: */*<br/>Connection: close
              <br/>pickup_minutes=15&delivery_minutes=30&paper_status=1&cell_signal=15
              <br/>WEB::Request Length: 351<br/>WEB::Request Page Status: 0
              <br/>AT+CSQ<br/>+CSQ: 20,0<br/>OK
              <br/>GSM::CSQ:20
              <br/>AT#SKTD=0,80,"api.eatabit.io",0,0<br/>CONNECT
              <br/>GSM::SEND: Socket Enabled<br/>GSM::RCXV: Header Sent
              <br/>HTTP/1.1 505 HTTP Version Not Supported<br/>Connection: close<br/>Server: Cowboy<br/>Date: Wec, 21 Oct 2014 19:22:32 GMT<br/>Content-Length: 0</pre>
            <hr/>
            <p class="indent">
              Wait...what?
            </p>
            <hr/>
            <pre>HTTP/1.1 505 HTTP Version Not Supported</pre>
            <hr/>
            <p class="indent">
              We have been running this same Arduino firmware version for 9 months without any issues and now this? 
              All of a sudden? 
              At midnight? 
              City-wide? 
              Smells funny... 
              And what is this?
            </p>
            <hr/>
            <pre>Server: Cowboy</pre>
            <hr/>
            <p class="indent">
              Our app runs on <a href="http://www.heroku.com">Heroku</a> and we use the <a href="http://unicorn.bogomips.org/">Unicorn</a> web server. 
              So what is this "Cowboy" who is speaking for our service?
            </p>
            <hr/>
            <p class="indent">
              Ok, let's break out cURL and replicate the request from the command line of my Mac: 
            </p>
            <hr/>
            <pre>curl "http://api.eatabit.io/v1/printer/***************/orders.text?pickup_minutes=30&delivery_minutes=90&state=ok" \<br/>> -X GET \<br/>> -u ***************:****************** \<br/>> -v \<br/>> --user-agent "Eatabit_Device/0.5.1"
              <br/>* Hostname was NOT found in DNS cache<br/>*   Trying 54.225.219.28...<br/>* Connected to api.eatabit.io (54.225.219.28) port 80 (#0)<br/>* Server auth using Basic with user '***************'<br/>> GET /v1/printer/***************/orders.text?pickup_minutes=30&delivery_minutes=90&state=ok  HTTP/1.1<br/>> Authorization: Basic ***********************************************<<br/>> User-Agent: Eatabit_Device/0.5.1<br/>> Host: api.eatabit.io<br/>> Accept: */*<br/>><br/>< HTTP/1.1 200 OK<br/>* Server Cowboy is not blacklisted<br/>< Server: Cowboy<br/>< Connection: keep-alive<br/>< Date: Mon, 21 Oct 2014 01:25:11 GMT<br/>< Status: 200 OK<br/>< Content-Type: text/plain<br/>< Content-Length: 7<br/>< Etag: "26f14889eed7cc4b3b78cc667c7ee9eb"<br/>< Cache-Control: max-age=0, private, must-revalidate<br/>< X-Request-Id: dce1a529-fff1-4222-b997-21d7c074487f<br/>< X-Runtime: 1.135825<br/>< Via: 1.1 vegur<br/><<br/>* Connection #0 to host api.eatabit.io left intact<br/>{0:0}{}%</pre>
            <hr/>
            <p class="indent">
              Ok, that passes...so, WTF?! 
              I guess we'll have to look into the Arduino firmware where the REST request is created.
            </p>
            <hr/>
            <pre>if(isCommsBufferAvailable()) {<br/>  //make the chunk<br/>  uint8_t dataLength = snprintf(( char * )tempString, sizeof(tempString), <br/>    "pickup_minutes=%hhu&delivery_minutes=%hhu&paper_status=%hhu&cell_signal=%hhu",<br/>    settings.getPickupMinutes(),<br/>    settings.getDeliveryMinutes(),<br/>    printer.hasPaper(),<br/>    gsmModem.getSignal()<br/>    );<br/>  uint8_t contentLength[4];<br/>  dataLength = strlen( ( char * ) tempString);<br/>  itoa(dataLength,( char * ) contentLength, 10);<br/>  <br/>  IF_DEBUG(DEBUG_INFO) PORT_DEBUG.println("WEB::Starting Poll!");<br/>  reserveCommsBuffer();<br/>  <br/>  //build the header for the POLL request<br/>  strcpy( ( char * ) commsOrderBuffer, "GET /v1/printer/");<br/>  <br/>  strcat( ( char * ) commsOrderBuffer, ( char * ) settings.getIMEI());<br/>  strcat( ( char * ) commsOrderBuffer, "/orders.txt  HTTP/1.1\r\n");<br/>  strcat( ( char * ) commsOrderBuffer, "HOST: ");<br/>  strcat( ( char * ) commsOrderBuffer, SERVER_NAME);<br/>  strcat( ( char * ) commsOrderBuffer, "\r\n");<br/>  strcat( ( char * ) commsOrderBuffer, "Authorization: Basic ");<br/>  <br/>  strcat( ( char * ) commsOrderBuffer, ( char * ) settings.getAccess());        <br/>  strcat( ( char * ) commsOrderBuffer, "\r\n");<br/>  strcat( ( char * ) commsOrderBuffer, "User-Agent: Eatabit_Device/");<br/>  strcat( ( char * ) commsOrderBuffer, SOFTWARE_VER);<br/>  strcat( ( char * ) commsOrderBuffer, "\r\n");<br/>  strcat( ( char * ) commsOrderBuffer, "Content-Length: ");<br/>  strcat( ( char * ) commsOrderBuffer, ( char * ) contentLength);<br/>  strcat( ( char * ) commsOrderBuffer, "\r\n");<br/>  strcat( ( char * ) commsOrderBuffer, "Content-Type: application/x-www-form-urlencoded\r\n");<br/>  strcat( ( char * ) commsOrderBuffer, "Accept: */*\r\n");<br/>  strcat( ( char * ) commsOrderBuffer, "Connection: close\r\n");      <br/>  strcat( ( char * ) commsOrderBuffer, "\r\n");<br/>  strcat( ( char * ) commsOrderBuffer, ( char * ) tempString);<br/>  IF_DEBUG(DEBUG_BUFFERS) {<br/>    temp1 = strlen((char*) commsOrderBuffer);<br/>    PORT_DEBUG.println("WEB::Poll Request: ");<br/>    PORT_DEBUG.println((char*)commsOrderBuffer);<br/>    PORT_DEBUG.print("WEB::Request Length: ");<br/>    PORT_DEBUG.println(temp1); <br/>  }<br/>  temp1 = gsmModem.requestPage( (uint8_t *) SERVER_NAME, PORT_NUMBER, commsOrderBuffer, commsOrderBuffer, ORDER_QUE_MAX_ORDER_SIZE);<br/>  IF_DEBUG(DEBUG_BUFFERS) {<br/>    PORT_DEBUG.print("WEB::Request Page Status: ");<br/>    PORT_DEBUG.println(temp1);<br/>  }<br/>  <br/>  //go wait for the response<br/>  _state = WEB_WAIT_POLL;<br/>} <br/>else {<br/>  IF_DEBUG(DEBUG_BUFFERS) PORT_DEBUG.println("WEB::Buffer In use!");<br/>}     <br/>break;</pre>
            <hr/>
            <p class="indent">
              Wait. 
              Is that...an extra whitespace char between the URL and HTTP version in the line:
            </p>
            <hr/>
            <pre>strcat( ( char * ) commsOrderBuffer, "/orders.txt  HTTP/1.1\r\n");</pre>
            <hr/>
            <p class="indent">
              So let's test the theory that Cowboy can't handle more than one character of whitespace between parsable params by adding one whitespace character to the end of the URL.
            </p>
            <hr/>
            <pre>curl "http://api.eatabit.io/v1/printer/***************/orders.text?pickup_minutes=30&delivery_minutes=90&state=ok " \<br/>-X GET \<br/>-u ***************:****************** \<br/>-v \<br/>--user-agent "Eatabit_Device/0.5.1"
              <br/>* Hostname was NOT found in DNS cache<br/>*   Trying 54.225.123.174...<br/>* Connected to api.eatabit.io (54.225.123.174) port 80 (#0)<br/>* Server auth using Basic with user '***************'<br/>> GET /v1/printer/***************/orders.text?pickup_minutes=30&delivery_minutes=90&state=ok  HTTP/1.1<br/>> Authorization: Basic ***********************************************<<<br/>> User-Agent: Eatabit_Device/0.5.1<br/>> Host: api.eatabit.io<br/>> Accept: */*<br/>><br/>< HTTP/1.1 505 HTTP Version Not Supported<br/>< Connection: close<br/>* Server Cowboy is not blacklisted<br/>< Server: Cowboy<br/>< Date: Mon, 27 Oct 2014 02:03:25 GMT<br/>< Content-Length: 0<br/><<br/>* Closing connection 0</pre>
            <hr/>
            <p class="indent">Twist!</p>
            <p>
              <img src="../assets/images/blog/git_diff.png" alt="eatabit printer">
            </p>
            <hr/>
            <p class="indent">
              Ok, so we have a bug in our code (in the form of the extra whitespace charater). 
              So why did this start all of a sudden? 
              That bug would have existed for at least 9 months on the firmware in the field...
            </p>
            <hr/>
            <p>
              <img src="../assets/images/blog/tlj.png" alt="eatabit printer">
            </p>
            <hr/>
            <p class="indent">So what changed?</p>
            <hr/>
            <pre>Server: Cowboy</pre>
            <hr/>
            <p class="indent">Cowboy. 
              Who is runnig the Cowboy server that is silently blocking our (admittedly malformed) requests? 
              Heroku? 
              AWS? 
              Cursory Google searches do not allude to either party's use of Cowboy. 
              We have requests submitted to both parties and are waiting to hear back... 
              Stay tuned.
            </p>
            <hr/>
          </div><!-- /.blog-post -->

        </div><!-- /.blog-main -->

        <div class="col-sm-3 col-sm-offset-1 blog-sidebar">
          <div class="sidebar-module sidebar-module-inset">
            <h4>About</h4>
            <p>We are a small startup in Charleston, SC. We take food orders over text message and print them inside restaurants.</p>
          </div>
          <div class="sidebar-module">
            <h4>Archives</h4>
            <ol class="list-unstyled">
              <li><a href="./articles/post-mortem-a-single-whitespace-char.html">Post Mortem: A single whitespace char</a></li>
              <li><a href="./articles/bill-murray-crashed-my-log-file.html">Bill Murray crashed my log file</a></li>
            </ol>
          </div>
        </div><!-- /.blog-sidebar -->

      </div><!-- /.row -->

      <div class="row">
        <p>
          <a href="#"><i class="fa fa-hand-o-up"></i> Back to top</a>
        </p>
      </div>

    </div><!-- /.container -->

    <div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
            <h4 class="modal-title" id="myModalLabel">Ordering a pizza in 60 seconds...</h4>
          </div>
          <div class="modal-body bg-success">
            <div class="pull-right" id="modal-text">
              <div>
                <p class="text-left">
                  <h3>Pizza in 60 seconds</h3>
                  <p class="lead">Never wait on hold again!</p>
                  <p>Check out this video. It's a real-time demo of eatabit.com's text message food ordering system. Seriously, that's how fast our system is!</p>
                  <p>We tell you the real pickup and delivery time of the restaurant and we send a confirmation when the order is printed at the restaurant.</p>
                  <p>Why hasn't anyone thought of this before?</p>
                </p>
              </div>
            </div>
            <iframe src="http://player.vimeo.com/video/90136179" width="250" height="444" frameborder="0" webkitallowfullscreen mozallowfullscreen allowfullscreen></iframe>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
          </div>
        </div>
      </div>
    </div>

    <script src="../assets/javascripts/jquery-2.1.0.min.js"></script>
    <script src="../assets/javascripts/bootstrap.min.js"></script>
    <script src="../assets/javascripts/application.js"></script>
  </body>
</html>
